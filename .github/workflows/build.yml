name: Build gamma.xml

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build correct gamma.xml
        run: |
          python3 << 'EOF'
          import glob
          import xml.etree.ElementTree as ET

          dataset = ET.Element("dataset")
          added = 0

          for file in sorted(glob.glob("*.xml")):
              if file in ("gamma.xml",):
                  continue
              try:
                  tree = ET.parse(file)
                  root = tree.getroot()
                  for record in root.findall("record"):
                      dataset.append(record)
                      added += 1
              except Exception as e:
                  print(f"Skipping {file}: {e}")

          ET.ElementTree(dataset).write(
              "gamma.xml",
              encoding="utf-8",
              xml_declaration=True
          )

          print(f"Added records: {added}")
          EOF

      - name: Generate md5
        run: md5sum gamma.xml | awk '{print $1}' > gamma.xml.md5

      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add gamma.xml gamma.xml.md5
          git commit -m "Generate correct gamma.xml and md5" || echo "No changes"
          git push

